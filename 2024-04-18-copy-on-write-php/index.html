<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <title>Descubra Como o PHP Utiliza Copy on Write para Economizar Mem√≥ria | Dias de Dev</title>
        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
            <meta name="robots" content="index, follow">
    <meta name="title" content="Descubra Como o PHP Utiliza Copy on Write para Economizar Mem√≥ria | Dias de Dev">
    <meta name="keywords" content="PHP, Copy on Write, CoW, Manipula√ß√£o de mem√≥ria, Otimiza√ß√£o de desempenho, Arrays, Efici√™ncia de c√≥digo, Economia de mem√≥ria, Estrat√©gias de programa√ß√£o, Desenvolvimento Web, Dias de Dev, Vinicius Dias, Alura">
    <meta name="description" content="Descubra como o PHP utiliza a t√©cnica de Copy on Write para economizar mem√≥ria ao manipular arrays. Entenda como essa estrat√©gia inteligente ajuda a maximizar a efici√™ncia do seu c√≥digo, evitando c√≥pias desnecess√°rias e otimizando o desempenho da sua aplica√ß√£o.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:article:published_time" content="1713398400">
    <meta property="og:url" content="https://dias.dev/2024-04-18-copy-on-write-php/">
    <meta property="og:title" content="Descubra Como o PHP Utiliza Copy on Write para Economizar Mem√≥ria | Dias de Dev">
    <meta property="og:description" content="Descubra como o PHP utiliza a t√©cnica de Copy on Write para economizar mem√≥ria ao manipular arrays. Entenda como essa estrat√©gia inteligente ajuda a maximizar a efici√™ncia do seu c√≥digo, evitando c√≥pias desnecess√°rias e otimizando o desempenho da sua aplica√ß√£o.">
    <meta property="og:image" content="https://dias.dev/assets/img/thumbs/2024-04-18-copy-on-write-php.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://dias.dev/2024-04-18-copy-on-write-php/">
    <meta property="twitter:title" content="Descubra Como o PHP Utiliza Copy on Write para Economizar Mem√≥ria | Dias de Dev">
    <meta property="twitter:description" content="Descubra como o PHP utiliza a t√©cnica de Copy on Write para economizar mem√≥ria ao manipular arrays. Entenda como essa estrat√©gia inteligente ajuda a maximizar a efici√™ncia do seu c√≥digo, evitando c√≥pias desnecess√°rias e otimizando o desempenho da sua aplica√ß√£o.">

    <link rel="preconnect" href="https://gravatar.com">
    <link rel="preconnect" href="https://utteranc.es">

    <link rel="prefetch" href="/build/social/facebook.svg" as="image" type="image/svg+xml">
    <link rel="prefetch" href="/build/social/twitter_x.svg" as="image" type="image/svg+xml">
    <link rel="prefetch" href="/build/social/linkedin.svg" as="image" type="image/svg+xml">
    <link rel="prefetch" href="/build/social/whatsapp.svg" as="image" type="image/svg+xml">

        <link rel="preload" href="/build/Baloo2-Bold.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/build/Baloo2-ExtraBold.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/build/Baloo2-Medium.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/build/Baloo2-Regular.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/build/Baloo2-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/build/FugazOne-Regular.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="stylesheet" href="/build/app.css">

        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Dias de Dev activity feed">
                <link rel="canonical"
              href="https://dias.dev/2024-04-18-copy-on-write-php/">
                    <link rel="stylesheet" href="/build/post.css">
                    </head>
    <body>
        <div class="global-container">
            <header>
                <div class="header-title">
                    <h1 class="main-heading">
                        <a aria-current="page" href="/">Dias de Dev</a>
                    </h1>
                </div>
                <nav class="menu">
                    <a aria-current="page" href="/">Home</a>
                    <a href="/categorias">Categorias</a>
                                        <a href="/sobre-mim/">Sobre Mim</a>
                    <a href="https://youtube.com/@DiasDeDev" target="_blank">
                        YouTube
                    </a>
                </nav>
            </header>
            <main>
                    <article itemscope itemtype="https://schema.org/Article">
        <header>
            <h1 itemprop="headline" class="post-title">
                Descubra Como o PHP Utiliza Copy on Write para Economizar Mem√≥ria
            </h1>
            <time class="post-date" itemprop="datePublished" pubdate datetime="2024-04-18">
                18 de abril de 2024
            </time>
        </header>
        <div itemprop="articleBody">
            <p><em>CoW (Copy on Write)</em>, significa que um dado s√≥ √© copiado em mem√≥ria se alguma escrita for feita nele. No PHP, isso significa que os dados de um <em>array</em> s√≥ s√£o copiados se n√≥s realizarmos alguma escrita nessa c√≥pia, evitando um grande desperd√≠cio de mem√≥ria. Vem comigo nesse texto para entender melhor.</p>

<h2 id="_arrays_-e-consumo-de-mem%C3%B3ria"><em>Arrays</em> e consumo de mem√≥ria</h2>

<p>Um <em>array</em>, em diversas linguagens, utiliza uma <em>estrutura de dados</em> conhecida como <strong>vetor</strong>, enquanto em PHP uma estrutura conhecida como <em>HashMap</em> √© utilizada por baixo dos panos. Mas independente de qual estrutura de dados √© utilizada, uma coisa √© √≥bvia: <em>arrays</em> podem ocupar bastante espa√ßo na mem√≥ria. PS.: se quiser aprender sobre estruturas de dados com PHP, aqui tem um <a href="https://tidd.ly/4d42Myb">cupom de desconto para a Alura</a> e l√° tem cursos sobre o assunto. üòâ</p>

<p>Pensa naquela √∫ltima query super demorada que voc√™ fez e retorna um caminh√£o de dados do banco. Agora imagina armazenar isso tudo em sua aplica√ß√£o PHP. Isso vai ocupar espa√ßo. Inclusive, na maioria das vezes vamos usar pagina√ß√£o de dados para n√£o cairmos em alguns problemas, mas isso √© assunto para outro post.</p>

<p>Vamos simular de forma bastante simples um <em>array</em> grande, e vamos ver quanta mem√≥ria ele ocupa. Para isso, vamos usar a fun√ß√£o <code>memory_get_usage</code> para recuperar o uso de mem√≥ria e a fun√ß√£o <code>array_fill</code> para criar um <em>array</em> com muitos dados.</p>

<pre><code class="php">&lt;?php

// Armazena o uso de mem√≥ria inicial
$memoriaInicial = memory_get_usage();

// Cria um array de 1000 elementos
$arrayGrande = array_fill(0, 1000, 'Valor de exemplo');

$memoriaUsada = memory_get_usage() - $memoriaInicial;

// Exibe a mem√≥ria ocupada em KB
echo $memoriaUsada / 1024;
</code></pre>

<p>O trecho de c√≥digo acima vai mostrar que utilizamos aproximadamente 20 <em>kilobytes</em> ap√≥s copiarmos um array contendo 1000 strings. Agora vamos realizar uma c√≥pia desse array grande. Podemos fazer isso o passando por par√¢metro para uma fun√ß√£o, ou simplesmente o associando a uma nova vari√°vel:</p>

<pre><code class="php">// ...
$copiaDoArray = $arrayGrande;
</code></pre>

<p>Sendo assim, eu esperaria que a mem√≥ria utilizada agora fosse de aproximadamente 40 <em>kilobytes</em>, j√° que tenho o array ocupando 20 KB duas vezes. Por√©m, se eu realizo a medi√ß√£o, tenho uma surpresa:</p>

<pre><code class="php">// ...
echo (memory_get_usage() - $memoriaInicial) / 1024;
</code></pre>

<p>Eu vejo agora um uso de aproximadamente 21 KB, ou seja, o consumo de mem√≥ria praticamente n√£o mudou. Um √∫nico <em>kilobyte</em> extra foi necess√°rio para armazenar o novo array de 20 KBs. Como?</p>

<h2 id="copy-on-write---php-ao-resgate">Copy on Write - PHP ao resgate</h2>

<p>O PHP entende que arrays s√£o uma estrutura de dados muito comum, muito utilizada e muito poderosa. Por isso, h√° uma t√©cnica bastante comum implementada por baixo dos panos nos <em>arrays</em> do PHP: <em>Copy on Write</em>, ou, no bom e velho portugu√™s, c√≥pia somente no momento da escrita.</p>

<p>O que isso quer dizer √© que, ao realizar uma "c√≥pia" de um array, ou seja, ao passar um array por par√¢metro ou atribu√≠-lo a outra vari√°vel, o PHP n√£o realiza uma c√≥pia nos dados em mem√≥ria. Ele, na verdade, faz com que esse par√¢metro ou vari√°vel apontem para o mesmo endere√ßo de mem√≥ria do array original, nos poupando muita mem√≥ria, principalmente em cen√°rio de grandes volumes de dados.</p>

<p>Por√©m, se ambos apontam para o mesmo endere√ßo de mem√≥ria, isso significa que ao manipular os itens desse novo array, eu acabaria alterando o array original tamb√©m, certo? Errado. Da√≠ que vem o nome da t√©cnica de <em>copy on write</em>. Ao tentar realizar alguma manipula√ß√£o nos dados dessa "c√≥pia", s√≥ ent√£o os dados ser√£o efetivamente copiados. Sendo assim, podemos ver o aumento no uso de mem√≥ria com o seguinte trecho de c√≥digo:</p>

<pre><code class="php">// ...
$copiaDoArray[1] = 'Outro valor';
echo (memory_get_usage() - $memoriaInicial) / 1024;
</code></pre>

<p>Agora, ap√≥s modificar a vari√°vel <code>$copiaDoArray</code>, uma c√≥pia dos dados em mem√≥ria ser√° realmente feita, ent√£o o uso de mem√≥ria finalmente dobrar√° e veremos um uso de aproximadamente 42KB.</p>

<h2 id="conclus%C3%A3o">Conclus√£o</h2>

<p><em>Arrays</em> s√£o extremamente vers√°teis e poderosos no PHP e por isso s√£o amplamente utilizados (√†s vezes at√© mal utilizados). Pensando nisso, o PHP faz de tudo para que seu uso seja o mais otimizado poss√≠vel, e garantir que c√≥pias desnecess√°rias sejam evitadas nos poupa <strong>muita</strong> RAM.</p>

<p>Se voc√™ quiser aprender mais sobre as "entranhas" do PHP, manipula√ß√£o de mem√≥ria, otimiza√ß√£o al√©m de boas pr√°ticas, l√° na Alura eu tenho v√°rios cursos sobre o assunto (e sobre outros temas tamb√©m). Aqui tem um <a href="https://tidd.ly/4d42Myb">cupom de 15% desconto</a> para voc√™ aproveitar a plataforma.</p>

        </div>
        <footer itemprop="author" itemscope itemtype="https://schema.org/Person">
            <div class="social-links-footer">
                <p>
                    Gostou desse post? Que tal compartilhar?
                </p>
                <span>
                    <a href="https://facebook.com/sharer/sharer.php?u=https://dias.dev/2024-04-18-copy-on-write-php/" target="_blank" aria-label="Compartilhar post no Facebook">
                        <img src="/build/social/facebook.svg" alt="Logo do Facebook" loading="lazy" width="25" height="25" />
                    </a>
                    <a href="https://twitter.com/intent/tweet/?text=Descubra%20Como%20o%20PHP%20Utiliza%20Copy%20on%20Write%20para%20Economizar%20Mem%C3%B3ria%20%7C%20Dias%20de%20Dev%0A&url=https://dias.dev/2024-04-18-copy-on-write-php/" target="_blank" aria-label="Compartilhar post no X (Twitter)">
                        <img src="/build/social/twitter_x.svg" alt="Logo do X (Twitter)" loading="lazy" width="25" height="25" />
                    </a>
                    <a href="https://linkedin.com/sharing/share-offsite/?url=https://dias.dev/2024-04-18-copy-on-write-php/" target="_blank" aria-label="Compartilhar post no LinkedIn">
                        <img src="/build/social/linkedin.svg" alt="Logo do LinkedIn" loading="lazy" width="25" height="25" />
                    </a>
                    <a href="https://api.whatsapp.com/send?text=https://dias.dev/2024-04-18-copy-on-write-php/" target="_blank" aria-label="Compartilhar post no WhatsApp">
                        <img src="/build/social/whatsapp.svg" alt="Logo do WhatsApp" loading="lazy" width="25" height="25" />
                    </a>
                </span>
            </div>
            <div class="post-author-footer">
                <img src="https://gravatar.com/avatar/63579c5a873f3ab6abff10803e9a252f.jpg?s=50"
                     alt="Foto do Vinicius Dias, um homem branco de cabelos escuros e curtos, em perfil com o fundo bem escuro em tons de azul enquanto mexe em um laptop durante uma apresenta√ß√£o."
                     width="50"
                     height="50"
                     loading="lazy"
                     itemprop="image">
                <p>
                    Escrito por
                    <a href="/sobre-mim/" itemprop="url">
                        <span itemprop="name">Vinicius Dias</span>
                    </a>
                </p>
            </div>
        </footer>

        <!-- TODO: Tema de acordo com as prefer√™ncias do usu√°rio -->
        <script src="https://utteranc.es/client.js"
                repo="cviniciussdias/cviniciussdias.github.io"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>

                    <nav class="article-navigation">
                <ul>
                    <li>
                                                <a class="previous" href="/2024-03-23-o-que-e-machine-learning/" title="Machine Learning com PHP: Aprendendo a Criar Algoritmos de Classifica√ß√£o">
                            ‚Üê <span class="title">Machine Learning com PHP: Aprendendo a Criar Algoritmos de Classifica√ß√£o</span>
                        </a>
                                            </li>
                    <li>
                                                <a class="next" href="/2024-05-10-locks-exclusivos-e-compartilhados-sql/" title="Locks de bancos de dados: Como Funcionam os Bloqueios Exclusivos e Compartilhados">
                            <span class="title">Locks de bancos de dados: Como Funcionam os Bloqueios Exclusivos e Compartilhados</span> ‚Üí
                        </a>
                                            </li>
                </ul>
            </nav>
            </article>
            </main>
            <footer class="global-footer">&copy; 2024 Dias de Dev</footer>
        </div>

        <script src="/build/app.js"></script>
                
        <!-- Simple Analytics -->
        <script defer src="https://sa.dias.dev/latest.js"></script>
        <script defer src="https://sa.dias.dev/auto-events.js"></script>
        <noscript>
            <img src="https://sa.dias.dev/noscript.gif"
                 alt=""
                 referrerpolicy="no-referrer-when-downgrade">
        </noscript>
        <script type="speculationrules">
            {
              "prerender": [
                {
                  "source": "document",
                  "where": {
                    "href_matches": "/*"
                  },
                  "eagerness": "moderate"
                }
              ]
            }
        </script>
                </body>
</html>
